name: vulnerability-scan
run-name: Scan published images for vulnerabilities.
env:
  REGISTRY: ghcr.io
on:
  push:
    branches:
      - 'build/**'
  registry_package:
    types:
      - "published"
  schedule:
    - cron: '14 0 * * 4'
    # 3 jobs?
    # event_name == push use matrix
    # schedule will use base branch (can still use matrix.images )
    # registry_package only the published package
jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        images: ${{ fromJson(vars.IMAGES) }}
        branches: ${{ fromJson(vars.BRANCHES) }}
        exclude:
          - images: ci-builder
            branches: 4.x
          - images: clamav
            branches: 4.x
          - images: elasticsearch
            branches: 4.x
          - images: mailhog
            branches: 4.x
          - images: mariadb
            branches: 4.x
          - images: nginx
            branches: 4.x
          - images: php-cli
            branches: 4.x
          - images: php-fpm
            branches: 4.x
          - images: ripple-static
            branches: 4.x
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Scan for vulnerabilities
        continue-on-error: true
        id: scan
        uses: crazy-max/ghaction-container-scan@v2
        with:
          image: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.images }}:${{matrix.branches}}
          dockerfile: ./images/${{ matrix.images }}
      - name: Upload SARIF file
        if: ${{ steps.scan.outputs.sarif != '' }}
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
