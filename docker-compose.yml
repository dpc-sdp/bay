version: '3.4'

x-environment:
  &default-environment
    LAGOON_ROUTE: ${LOCALDEV_URL:-http://bay.docker.amazee.io}
    AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
    AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
    AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-ap-southeast-2}

x-args:
  &default-args
    LAGOON_IMAGE_VERSION: ${LAGOON_IMAGE_VERSION:-latest}

services:
  buildx:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/buildx
    environment:
      << : *default-environment
    networks:
      - default

  cli:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/php-cli:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  nginx:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/nginx:${IMAGE_TAG:-5.x}
    ports:
      - 8080
    depends_on:
      - php
    environment:
      << : *default-environment
    networks:
      - default

  php:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/php-fpm:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  php_goss:
    build:
      context: ./images/bay-php_goss
      dockerfile: $PWD/images/bay-php_goss/Dockerfile
      args:
        BASE_IMAGE: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/php-cli:${IMAGE_TAG:-5.x}
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/php_goss:${IMAGE_TAG:-5.x}
    depends_on:
      - cli
      - php
    environment:
      << : *default-environment
    networks:
      - default

  node:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/node:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  mariadb:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/mariadb:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  ci-builder:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/ci-builder:${IMAGE_TAG:-5.x}
    command: tail -F anything
    environment:
      << : *default-environment
    networks:
      - default

  ripple-static:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/ripple-static:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  test:
    image: ${REGISTRY_NAMESPACE:-ghcr.io/dpc-sdp/bay}/test
    networks:
      - default

networks:
  default:
    external: false
