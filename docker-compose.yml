version: '3.4'

x-environment:
  &default-environment
    LAGOON_ROUTE: ${LOCALDEV_URL:-http://bay.docker.amazee.io}

x-args:
  &default-args
    LAGOON_IMAGE_VERSION: ${LAGOON_IMAGE_VERSION:-latest}

services:
  buildx:
    build:
      context: ./images/bay-buildx
      dockerfile: $PWD/images/bay-buildx/Dockerfile
      args:
        << : *default-args
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/ci-buildx
    environment:
      << : *default-environment
    networks:
      - default

  cli:
    build:
      context: ./images/bay-php
      dockerfile: $PWD/images/bay-php/Dockerfile.cli
      args:
        << : *default-args
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-php-cli:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  nginx:
    build:
      context: ./images/bay-nginx
      dockerfile: $PWD/images/bay-nginx/Dockerfile
      args:
        << : *default-args
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-nginx:${IMAGE_TAG:-5.x}
    ports:
      - 8080
    depends_on:
      - php
    environment:
      << : *default-environment
    networks:
      - default

  php:
    build:
      context: ./images/bay-php
      dockerfile: $PWD/images/bay-php/Dockerfile.fpm
      args:
        << : *default-args
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-php-fpm:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  php_goss:
    build:
      context: ./images/bay-php_goss
      dockerfile: $PWD/images/bay-php_goss/Dockerfile
      args:
        BASE_IMAGE: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-php-cli:${IMAGE_TAG:-5.x}
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/php_goss:${IMAGE_TAG:-5.x}
    depends_on:
      - cli
    environment:
      << : *default-environment
    networks:
      - default
    depends_on:
      - php

  node:
    build:
      context: ./images/bay-node
      dockerfile: $PWD/images/bay-node/Dockerfile
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-node:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  mariadb:
    build:
      context: ./images/bay-mariadb
      dockerfile: $PWD/images/bay-mariadb/Dockerfile
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-mariadb:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  ci-builder:
    build:
      context: ./images/bay-ci-builder
      dockerfile: $PWD/images/bay-ci-builder/Dockerfile
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-ci-builder:${IMAGE_TAG:-5.x}
    command: tail -F anything
    environment:
      << : *default-environment
    networks:
      - default

  ripple-static:
    build:
      context: ./images/bay-ripple-static
      dockerfile: $PWD/images/bay-ripple-static/Dockerfile
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/bay-ripple-static:${IMAGE_TAG:-5.x}
    environment:
      << : *default-environment
    networks:
      - default

  test:
    build:
      context: ./images/bay-test
      dockerfile: $PWD/images/bay-test/Dockerfile
    image: ${DOCKERHUB_NAMESPACE:-singledigital}/test
    networks:
      - default

networks:
  default:
    external: false
